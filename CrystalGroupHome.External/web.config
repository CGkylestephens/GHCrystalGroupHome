<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      <!-- ASP.NET Core Module configuration -->
      <handlers>
        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
      </handlers>
      <aspNetCore processPath="dotnet" 
                  arguments=".\CrystalGroupHome.External.dll" 
                  stdoutLogEnabled="false" 
                  stdoutLogFile=".\logs\stdout" 
                  hostingModel="inprocess">
        <!-- Environment variables for ASP.NET Core -->
        <environmentVariables>
          <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
        </environmentVariables>
      </aspNetCore>
      
      <!-- Security headers and header removals are now managed at the IIS server level -->
      <!-- to centralize configuration across all applications on the same server -->
      
      <!-- Ensure all requests go through ASP.NET Core middleware (including static files) -->
      <!-- This ensures Content-Security-Policy headers are applied to all responses -->
      <modules runAllManagedModulesForAllRequests="false" />
      
      <!-- URL Rewrite rules for HTTPS enforcement -->
      <rewrite>
        <rules>
          <!-- Redirect HTTP to HTTPS -->
          <rule name="HTTPS Redirect" stopProcessing="true">
            <match url="(.*)" />
            <conditions>
              <add input="{HTTPS}" pattern="off" ignoreCase="true" />
            </conditions>
            <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
          </rule>
        </rules>
      </rewrite>
    </system.webServer>
  </location>
  
  <!-- Additional security configuration for ASP.NET -->
  <system.web>
    <!-- Remove ASP.NET version header -->
    <httpRuntime enableVersionHeader="false" />
  </system.web>
</configuration>
